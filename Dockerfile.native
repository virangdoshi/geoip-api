# build stage
FROM ghcr.io/graalvm/graalvm-ce:21.3.0 AS builder

ARG MAVEN_VERSION=3.8.4
ARG BASE_URL=https://dlcdn.apache.org/maven/maven-3/${MAVEN_VERSION}/binaries
ARG VERSION=0-SNAPSHOT

ADD . /build
WORKDIR /build

# Install maven
RUN mkdir -p /usr/share/maven /usr/share/maven/ref \
  && curl -fsSL -o /tmp/apache-maven.tar.gz ${BASE_URL}/apache-maven-${MAVEN_VERSION}-bin.tar.gz \
  && tar -xzf /tmp/apache-maven.tar.gz -C /usr/share/maven --strip-components=1 \
  && rm -f /tmp/apache-maven.tar.gz \
  && ln -s /usr/share/maven/bin/mvn /usr/bin/mvn

# build image
RUN mvn --batch-mode --no-transfer-progress clean package -Pnative -DskipTests=true -Drevision=${VERSION}

# run stage
FROM oraclelinux:8-slim
ARG MAXMIND_LICENSE_KEY
ARG CREATED_AT
ARG VERSION
ARG GIT_REVISION

# Add labels to identify release
LABEL org.opencontainers.image.authors="Torsten B. KÃ¶ster <tbk@thiswayup.de>" \
      org.opencontainers.image.url="https://github.com/observabilitystack/geoip-api" \
      org.opencontainers.image.licenses="Apache-2.0" \
      org.opencontainers.image.title="Geoip-API" \
      org.opencontainers.image.description="A JSON REST API for Maxmind GeoIP databases" \
      org.opencontainers.image.created="${CREATED_AT}" \
      org.opencontainers.image.version="${VERSION}" \
      org.opencontainers.image.revision="${GIT_REVISION}"

# download current maxmind databases
WORKDIR /srv
RUN microdnf install -y tar gzip && \
    curl -sfSL "https://download.maxmind.com/app/geoip_download?edition_id=GeoLite2-City&suffix=tar.gz&license_key=${MAXMIND_LICENSE_KEY}" | tar -xz && \
    curl -sfSL "https://download.maxmind.com/app/geoip_download?edition_id=GeoLite2-ASN&suffix=tar.gz&license_key=${MAXMIND_LICENSE_KEY}" | tar -xz && \
    ln -s GeoLite2-City_*/GeoLite2-City.mmdb . && \
    ln -s GeoLite2-ASN_*/GeoLite2-ASN.mmdb .

# place app
COPY --from=builder "/build/target/geoip-api" /srv/geoip-api

ENV CITY_DB_FILE /srv/GeoLite2-City.mmdb
ENV ASN_DB_FILE  /srv/GeoLite2-ASN.mmdb
HEALTHCHECK --interval=5s --timeout=1s CMD curl -f http://localhost:8080/actuator/health
EXPOSE 8080
CMD exec /srv/geoip-api
